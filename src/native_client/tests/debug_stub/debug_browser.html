<!--
  Copyright 2011 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can
  be found in the LICENSE file.
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
  <script type="text/javascript" src="nacltest.js"></script>
  <title>Debug Test</title>
  </head>

  <h1>Native Client In Browser Debug Test</h1>
  <body>
    <div id="attach"></div>
    <br>This test starts a nexe which sends and receives messages.<br>
  </body>
  <script type="text/javascript">
    //<![CDATA[
function setupTests(tester, plugin) {

  function TestPostMessage(status, msgToSend) {
    var listener = status.wrap(function(message) {
      plugin.removeEventListener('message', listener, false);
      status.log('Received onmessage event: ' + message.data);
      // The debug_browser nexe receives |string| and returns
      // 'Nexe received {|string|}'
      var expectedReply = 'Nexe received {' + msgToSend + '}';
      status.assertEqual(message.data, expectedReply);
      status.pass();
    });

    plugin.addEventListener("message", listener, false);
    plugin.postMessage(msgToSend);
  }

  tester.addAsyncTest('first', function(status) {
      TestPostMessage(status, 'First string value');
    });
  tester.addAsyncTest('second', function(status) {
      TestPostMessage(status, 'Second string value');
    });
}

var node = document.createElement('div');
node.innerHTML = '<embed id="naclModule" ' +
                 'name="naclModule" ' +
                 'width=0 height=0 ' +
                 'src="debug_browser_test.nmf" ' +
                 'basic_tests="1" ' +
                 'stress_tests="0" ' +
                 'style="background-color:gray" ' +
                 'type="application/x-nacl"/>';
document.getElementById('attach').appendChild(node);

var tester = new Tester();
setupTests(tester, $('naclModule'));
tester.waitFor($('naclModule'));
tester.run();
    //]]>
  </script>
</html>
