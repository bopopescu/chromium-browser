# -*- python -*-
# Copyright 2012 The Native Client Authors.  All rights reserved.
# Use of this source code is governed by a BSD-style license that can
# be found in the LICENSE file.

Import('env')

# We do not expect the blob library to be produced by linking against
# nacl-glibc.
if env.Bit('nacl_glibc'):
  Return()

# PNaCl translator handles linker flags differently in pexe mode
if env.Bit('bitcode') and env.Bit('pnacl_generate_pexe'):
  Return()

if env.Bit('bitcode'):
  env.PNaClForceNative()

env.Append(LINKFLAGS='-Wl,--section-start,.rodata=${IRT_DATA_REGION_START}')
# An explicit output name is specified so an object file is created in the
# blob_library_loading output directory.
hw_o = env.ComponentObject('hello_world.o', '../hello_world/hello_world.c')
user_executable = env.ComponentProgram(
    'hello_world_with_segment_gap',
    hw_o,
    EXTRA_LIBS=['${NONIRT_LIBS}'])

node = env.CommandSelLdrTestNacl(
    'blob_library_loading_test.out',
    user_executable,
    sel_ldr_flags=['-B', env.GetIrtNexe()],
    stdout_golden=env.File('${SCONSTRUCT_DIR}/tests/hello_world'
                           '/hello_world.stdout'))
env.AddNodeToTestSuite(node, ['small_tests', 'nonpexe_tests'],
                       'run_blob_library_loading_test')
